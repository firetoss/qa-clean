# QA Clean é¡¹ç›®å•å…ƒæµ‹è¯•

æœ¬ç›®å½•åŒ…å« QA Clean é¡¹ç›®çš„å®Œæ•´å•å…ƒæµ‹è¯•å¥—ä»¶ï¼Œè¦†ç›–æ ¸å¿ƒåŠŸèƒ½æ¨¡å—å’Œä¸šåŠ¡é€»è¾‘ã€‚

## ğŸ“ æµ‹è¯•ç»“æ„

```
tests/
â”œâ”€â”€ README.md              # æµ‹è¯•æ–‡æ¡£
â”œâ”€â”€ __init__.py             # æµ‹è¯•åŒ…åˆå§‹åŒ–
â”œâ”€â”€ test_runner.py          # æµ‹è¯•è¿è¡Œå™¨ï¼ˆå½©è‰²è¾“å‡ºã€åˆ†ç±»è¿è¡Œï¼‰
â”œâ”€â”€ test_config.yaml        # æµ‹è¯•é…ç½®æ–‡ä»¶
â”œâ”€â”€ utils/                  # å·¥å…·æ¨¡å—æµ‹è¯•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_cn_text.py     # ä¸­æ–‡æ–‡æœ¬å¤„ç†æµ‹è¯•
â”‚   â”œâ”€â”€ test_io_utils.py    # IOå·¥å…·æµ‹è¯•
â”‚   â”œâ”€â”€ test_config.py      # é…ç½®ç®¡ç†æµ‹è¯•
â”‚   â””â”€â”€ test_text_sim.py    # æ–‡æœ¬ç›¸ä¼¼åº¦æµ‹è¯•
â””â”€â”€ stages/                 # é˜¶æ®µæ¨¡å—æµ‹è¯•
    â”œâ”€â”€ __init__.py
    â””â”€â”€ test_stage1_filter.py # Stage1è¿‡æ»¤æµ‹è¯•
```

## ğŸ§ª æµ‹è¯•æ¨¡å—è¯¦è¿°

### å·¥å…·æ¨¡å—æµ‹è¯• (`tests/utils/`)

#### 1. `test_cn_text.py` - ä¸­æ–‡æ–‡æœ¬å¤„ç†æµ‹è¯•
- **æµ‹è¯•èŒƒå›´**: æ–‡æœ¬è§„èŒƒåŒ–ã€å…¨è§’è½¬åŠè§’ã€è¿‡æ»¤è§„åˆ™
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `to_halfwidth()`: å…¨è§’å­—ç¬¦è½¬åŠè§’
  - `normalize_zh()`: ä¸­æ–‡æ–‡æœ¬æ ‡å‡†åŒ–
  - `filter_reason()`: é—®é¢˜è¿‡æ»¤é€»è¾‘
  - `match_any()`: æ­£åˆ™æ¨¡å¼åŒ¹é…
- **æµ‹è¯•ç‰¹è‰²**: 
  - ä¸­æ–‡Unicodeå¤„ç†
  - æ ‡ç‚¹ç¬¦å·æ˜ å°„
  - ç™½åå•/é»‘åå•ä¼˜å…ˆçº§
  - è¾¹ç•Œæƒ…å†µå¤„ç†

#### 2. `test_io_utils.py` - IOå·¥å…·æµ‹è¯•
- **æµ‹è¯•èŒƒå›´**: æ–‡ä»¶è¯»å†™ã€å¤šæ ¼å¼æ”¯æŒã€é”™è¯¯å¤„ç†
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `read_data_file()`: æ™ºèƒ½æ–‡ä»¶è¯»å–ï¼ˆparquet/xlsx/csvï¼‰
  - `save_npy()`: NumPyæ•°ç»„ä¿å­˜
  - `save_json_merge()`: JSONåˆå¹¶ä¿å­˜
  - `ensure_parent_dir()`: ç›®å½•åˆ›å»º
- **æµ‹è¯•ç‰¹è‰²**:
  - Mockå¤–éƒ¨ä¾èµ–
  - æ–‡ä»¶æ ¼å¼è‡ªåŠ¨æ£€æµ‹
  - ç¼–ç å…¼å®¹æ€§æµ‹è¯•
  - é”™è¯¯æ¢å¤æœºåˆ¶

#### 3. `test_config.py` - é…ç½®ç®¡ç†æµ‹è¯•
- **æµ‹è¯•èŒƒå›´**: é…ç½®åŠ è½½ã€éªŒè¯ã€è·¯å¾„è§£æ
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `Config.get()`: åµŒå¥—è·¯å¾„è®¿é—®
  - `load_config()`: YAMLé…ç½®åŠ è½½
  - `_validate_config()`: é…ç½®éªŒè¯
  - `ensure_seed()`: éšæœºç§å­è®¾ç½®
- **æµ‹è¯•ç‰¹è‰²**:
  - åµŒå¥—é…ç½®è®¿é—®
  - å‚æ•°èŒƒå›´éªŒè¯
  - æ–‡ä»¶é”™è¯¯å¤„ç†
  - é»˜è®¤å€¼æœºåˆ¶

#### 4. `test_text_sim.py` - æ–‡æœ¬ç›¸ä¼¼åº¦æµ‹è¯•
- **æµ‹è¯•èŒƒå›´**: å­—ç¬¦n-gramã€ç›¸ä¼¼åº¦è®¡ç®—ã€ç¼–è¾‘è·ç¦»
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `char_ngrams()`: å­—ç¬¦çº§n-gramç”Ÿæˆ
  - `jaccard()`: Jaccardç›¸ä¼¼åº¦
  - `ngram_jaccard()`: n-gram Jaccardç›¸ä¼¼åº¦
  - `edit_distance()`: ç¼–è¾‘è·ç¦»è®¡ç®—
- **æµ‹è¯•ç‰¹è‰²**:
  - ä¸­æ–‡å­—ç¬¦å¤„ç†
  - æ•°å­¦æ­£ç¡®æ€§éªŒè¯
  - æ€§èƒ½ç‰¹å¾æµ‹è¯•
  - å¯¹ç§°æ€§éªŒè¯

### é˜¶æ®µæ¨¡å—æµ‹è¯• (`tests/stages/`)

#### 1. `test_stage1_filter.py` - Stage1è¿‡æ»¤æµ‹è¯•
- **æµ‹è¯•èŒƒå›´**: æ•°æ®åŠ è½½ã€æ–‡æœ¬è¿‡æ»¤ã€ç»Ÿè®¡ç”Ÿæˆ
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `_load_or_sample()`: æ•°æ®åŠ è½½é€»è¾‘
  - `run()`: å®Œæ•´è¿‡æ»¤æµç¨‹
  - æ–‡ä»¶æ ¼å¼æ”¯æŒ
  - ç»Ÿè®¡ä¿¡æ¯ç”Ÿæˆ
- **æµ‹è¯•ç‰¹è‰²**:
  - Mockæ•°æ®æ¡†æ“ä½œ
  - å¤šç§æ–‡ä»¶æ ¼å¼
  - è¿‡æ»¤ç»Ÿè®¡éªŒè¯
  - é”™è¯¯æ¢å¤æµ‹è¯•

## ğŸš€ è¿è¡Œæµ‹è¯•

### åŸºæœ¬è¿è¡Œå‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test

# æŒ‰ç±»åˆ«è¿è¡Œ
make test-utils      # å·¥å…·æ¨¡å—æµ‹è¯•
make test-stages     # é˜¶æ®µæ¨¡å—æµ‹è¯•

# è¿è¡Œç‰¹å®šæ¨¡å—
make test-cn-text    # ä¸­æ–‡æ–‡æœ¬å¤„ç†
make test-io         # IOå·¥å…·
make test-config     # é…ç½®ç®¡ç†
make test-sim        # æ–‡æœ¬ç›¸ä¼¼åº¦
make test-stage1     # Stage1è¿‡æ»¤
```

### é«˜çº§é€‰é¡¹

```bash
# è¯¦ç»†è¾“å‡º
make test-verbose

# é™é»˜æ¨¡å¼
make test-quiet

# åˆ—å‡ºæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
make test-list

# è‡ªå®šä¹‰Pythonè§£é‡Šå™¨
make test PY=python3
```

### ç›´æ¥ä½¿ç”¨æµ‹è¯•è¿è¡Œå™¨

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python3 tests/test_runner.py

# è¿è¡Œç‰¹å®šç±»åˆ«
python3 tests/test_runner.py --category utils

# è¿è¡Œç‰¹å®šæ¨¡å—
python3 tests/test_runner.py --module tests.utils.test_cn_text

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
python3 tests/test_runner.py --module tests.utils.test_cn_text.TestChineseTextProcessing.test_to_halfwidth

# ç¦ç”¨å½©è‰²è¾“å‡º
python3 tests/test_runner.py --no-color

# è°ƒæ•´è¯¦ç»†ç¨‹åº¦
python3 tests/test_runner.py --verbosity 0  # é™é»˜
python3 tests/test_runner.py --verbosity 1  # æ­£å¸¸
python3 tests/test_runner.py --verbosity 2  # è¯¦ç»†
```

## ğŸ¯ æµ‹è¯•è®¾è®¡åŸåˆ™

### 1. **å…¨é¢è¦†ç›–**
- æ ¸å¿ƒåŠŸèƒ½é€»è¾‘æµ‹è¯•
- è¾¹ç•Œæƒ…å†µå¤„ç†
- é”™è¯¯æ¢å¤æœºåˆ¶
- å‚æ•°éªŒè¯

### 2. **ç‹¬ç«‹æ€§**
- æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç‹¬ç«‹è¿è¡Œ
- ä¸ä¾èµ–å¤–éƒ¨çŠ¶æ€
- ä½¿ç”¨Mockéš”ç¦»ä¾èµ–
- ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨æ¸…ç†

### 3. **å¯è¯»æ€§**
- æè¿°æ€§æµ‹è¯•åç§°
- æ¸…æ™°çš„æµ‹è¯•ç»“æ„
- è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜
- å­æµ‹è¯•ç»„ç»‡

### 4. **ä¸­æ–‡æ”¯æŒ**
- ä¸“é—¨çš„ä¸­æ–‡æ–‡æœ¬æµ‹è¯•
- Unicodeå¤„ç†éªŒè¯
- ç¼–ç å…¼å®¹æ€§æµ‹è¯•
- ä¸­æ–‡ä¸šåŠ¡é€»è¾‘æµ‹è¯•

## ğŸ”§ Mockç­–ç•¥

### å¤–éƒ¨ä¾èµ–Mock
- **pandas**: æ•°æ®æ¡†æ“ä½œMock
- **sentence_transformers**: æ¨¡å‹åŠ è½½Mock
- **torch**: æ·±åº¦å­¦ä¹ æ¡†æ¶Mock
- **æ–‡ä»¶ç³»ç»Ÿ**: ä¸´æ—¶ç›®å½•å’Œæ–‡ä»¶

### MockæŠ€æœ¯
- `unittest.mock.patch`: å‡½æ•°/æ–¹æ³•Mock
- `unittest.mock.MagicMock`: å¯¹è±¡Mock
- `tempfile`: ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•
- `StringIO`: å†…å­˜æ–‡ä»¶å¯¹è±¡

## ğŸ“Š æµ‹è¯•è¾“å‡º

### å½©è‰²è¾“å‡ºç¤ºä¾‹
```
ğŸ§ª QA Clean é¡¹ç›®å•å…ƒæµ‹è¯•
==================================================
ğŸ“Š å‘ç° 25 ä¸ªæµ‹è¯•ç”¨ä¾‹

âœ“ test_to_halfwidth - æµ‹è¯•å…¨è§’è½¬åŠè§’åŠŸèƒ½
âœ“ test_normalize_zh - æµ‹è¯•ä¸­æ–‡æ–‡æœ¬å½’ä¸€åŒ–åŠŸèƒ½
âœ“ test_filter_reason_whitelist - æµ‹è¯•ç™½åå•è¿‡æ»¤é€»è¾‘
- test_large_file_processing - SKIPPED: éœ€è¦å¤§æ–‡ä»¶æµ‹è¯•æ•°æ®

==================================================
ğŸ“ˆ æµ‹è¯•æ€»ç»“
--------------------------------------------------
æ€»æµ‹è¯•æ•°: 25
âœ“ æˆåŠŸ: 23
- è·³è¿‡: 2
â±ï¸  è€—æ—¶: 0.12ç§’
ğŸ“Š æˆåŠŸç‡: 92.0%
```

## ğŸš§ ä¾èµ–è¦æ±‚

### æœ€å°ä¾èµ–
æµ‹è¯•å¯ä»¥åœ¨æœ€å°Pythonç¯å¢ƒä¸­è¿è¡Œï¼Œæ ¸å¿ƒé€»è¾‘æµ‹è¯•ä¸ä¾èµ–å¤–éƒ¨åº“ï¼š
- Python 3.11+ æ ‡å‡†åº“
- unittest (å†…ç½®)
- tempfile (å†…ç½®)
- os, sys (å†…ç½®)

### å®Œæ•´æµ‹è¯•ä¾èµ–
å®Œæ•´åŠŸèƒ½æµ‹è¯•éœ€è¦é¡¹ç›®ä¾èµ–ï¼š
- pandas: æ•°æ®æ¡†æµ‹è¯•
- numpy: æ•°ç»„æ“ä½œæµ‹è¯•
- yaml: é…ç½®æ–‡ä»¶æµ‹è¯•
- å…¶ä»–é¡¹ç›®ä¾èµ–

## ğŸ¨ è‡ªå®šä¹‰æµ‹è¯•

### æ·»åŠ æ–°æµ‹è¯•æ¨¡å—

1. åœ¨é€‚å½“ç›®å½•åˆ›å»º `test_*.py` æ–‡ä»¶
2. ç»§æ‰¿ `unittest.TestCase`
3. ç¼–å†™æµ‹è¯•æ–¹æ³• (ä»¥ `test_` å¼€å¤´)
4. æ·»åŠ åˆ°Makefile (å¯é€‰)

ç¤ºä¾‹ï¼š
```python
import unittest

class TestNewFeature(unittest.TestCase):
    def test_new_function(self):
        """æµ‹è¯•æ–°åŠŸèƒ½"""
        result = new_function("input")
        self.assertEqual(result, "expected")

if __name__ == '__main__':
    unittest.main()
```

### è‡ªå®šä¹‰æµ‹è¯•è¿è¡Œå™¨

å¯ä»¥æ‰©å±• `tests/test_runner.py` æ·»åŠ æ–°åŠŸèƒ½ï¼š
- æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ
- æ€§èƒ½æµ‹è¯•æ”¯æŒ
- é›†æˆæµ‹è¯•åˆ†ç±»
- è‡ªå®šä¹‰è¾“å‡ºæ ¼å¼

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒéš”ç¦»**: æµ‹è¯•ä½¿ç”¨ä¸´æ—¶ç›®å½•ï¼Œä¸å½±å“å®é™…æ•°æ®
2. **è·³è¿‡æœºåˆ¶**: ç¼ºå°‘ä¾èµ–æ—¶è‡ªåŠ¨è·³è¿‡ç›¸å…³æµ‹è¯•
3. **ä¸­æ–‡ç¼–ç **: ç¡®ä¿ç»ˆç«¯æ”¯æŒUTF-8æ˜¾ç¤ºä¸­æ–‡æµ‹è¯•ç»“æœ
4. **Pythonç‰ˆæœ¬**: é’ˆå¯¹Python 3.11+è®¾è®¡å’Œæµ‹è¯•

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Importé”™è¯¯**: æ£€æŸ¥Pythonè·¯å¾„å’Œä¾èµ–å®‰è£…
2. **ç¼–ç é—®é¢˜**: ç¡®ä¿ç»ˆç«¯UTF-8ç¼–ç 
3. **æƒé™é”™è¯¯**: æ£€æŸ¥æµ‹è¯•ç›®å½•å†™å…¥æƒé™
4. **ä¾èµ–ç¼ºå¤±**: ä½¿ç”¨condaå®‰è£…å®Œæ•´ä¾èµ–

### è°ƒè¯•æŠ€å·§

1. ä½¿ç”¨ `--verbosity 2` æŸ¥çœ‹è¯¦ç»†è¾“å‡º
2. è¿è¡Œå•ä¸ªæµ‹è¯•æ–¹æ³•å®šä½é—®é¢˜
3. æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶å†…å®¹è°ƒè¯•
4. ä½¿ç”¨IDEæ–­ç‚¹è°ƒè¯•å¤æ‚é€»è¾‘

---

å•å…ƒæµ‹è¯•ç¡®ä¿äº†QA Cleané¡¹ç›®çš„ä»£ç è´¨é‡å’ŒåŠŸèƒ½æ­£ç¡®æ€§ï¼Œä¸ºæŒç»­å¼€å‘å’Œé‡æ„æä¾›äº†å¯é ä¿éšœã€‚
